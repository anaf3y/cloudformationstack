version: 0.2
env:
  variables:
    NAME: rootloginapi
  parameter-store:
    BUCKET: "/InfrastructureParameters/cloudformationbucketname"
phases:
    install:
      runtime-versions:
        python: 3.7
      commands:
        - echo "Install sam cli"
        - pip install aws-sam-cli
        - echo "Setup github auth"
        - git config --global url."https://${TOKEN}:@github.com/".insteadOf "https://github.com/"
    build:
      commands:
        - echo "Build"
        - sam build --template ./template.yaml --build-dir ./.aws-sam/build --debug
        - sam package --template-file ./.aws-sam/build/template.yaml --output-template-file ./.aws-sam/build/packaged-template.yaml --s3-bucket $BUCKET
        - sam deploy --template-file ./.aws-sam/build/packaged-template.yaml --stack-name $NAME --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM
